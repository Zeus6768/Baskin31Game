<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="31Game.css">
    <title>31Game</title>
</head>

<body>

    <div id="gameIceCreamImage">
        <img src="image/iceCream/almondBonbon.png" width="200">
        <img src="image/iceCream/mintChoco.png" width="200">
        <img src="image/iceCream/momIsAlien.png" width="200">
        <img src="image/iceCream/newYorkCheese.png" width="200">
        <img src="image/iceCream/shootingStar.png" width="200">

        <br>
        <h2 class="name"></h2>
        <h2 class="name"></h2>
        <h2 class="name"></h2>
        <h2 class="name"></h2>
        <h2 class="name"></h2>

        <br><br><br>

    </div>

    <div class="numberContainer">
        <input type="text" class="numberBox" value="1" onclick="selectNumber(this)">
        <input type="text" class="numberBox" value="2" onclick="selectNumber(this)">
        <input type="text" class="numberBox" value="3" onclick="selectNumber(this)">
    </div>

    <p id="selectedNumber"></p>

    <div id="gamePage">
        <button id="submitNumber" type="submit" onclick="submitNumber(selectedNumber)" disabled>입력하기</button>
    </div>



</body>

<footer>
    KAU 2022-1 김서현, 신재우, 장예빈, 정수현, 철멍어드
</footer>

</html>

<script src="/socket.io/socket.io.js"></script>
<script>
    const socket = io();
    const username = new URLSearchParams(location.search).get('username');
    let selectedNumber = 0;
    let submitAllowed = false;

    // 대기실 입장 시 서버에 유저 이름 알림
    socket.emit('userInGame', username);

    // 새로운 유저 입장
    socket.on('usersInServer', users => {
        // 이 유저가 서버의 유저 목록 안에 있는지 확인
        const isValid = users.find(user => username === user.name)
        
        // 유저 접속 시 갱신
        for (let i=0; i<5; i++) {
            const names = document.getElementsByClassName('name');
            if (users[i] && users[i].inGame) {
                names[i].innerHTML = users[i].name;
            } else if (users[i] && users[i].name) {
                names[i].innerHTML = users[i].name + '(대기중)';
            } else {
                names[i].innerHTML = '오류';
            }
        }
    });

    // 게임시작 가능 여부 알림
    socket.on('gameStart', data => {
        if (data.gameActive && data.firstUser === username) {
            document.getElementById('submitNumber').disabled = false;
        } else {
            document.getElementById('submitNumber').disabled = true;
        }
        console.log(data.message);
    })

    // 인게임
    socket.on('broadcastNumber', data => {
        const numberBoxes = document.getElementsByClassName('numberBox');
        for (let i=0; i<3; i++) {
            numberBoxes[i].value = String(data.number + i);
        }
    })

    function selectNumber(event) {
        document.getElementById('selectedNumber').innerHTML = '선택한 수 : ' + event.value;
        selectedNumber = event.value;
    }

    function submitNumber(number) {
        socket.emit('submitNumber', number);
    }
</script>